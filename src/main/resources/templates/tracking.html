<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Order Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        .full-height-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #ff3030;
            color: white;
            padding-top: 1rem;
            overflow-y: auto;
        }

        .sidebar a {
            color: #fff;
            padding: 15px;
            display: block;
            text-decoration: none;
        }

        .sidebar a:hover {
            background-color: #495057;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .navbar-sticky {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .scrollable-section {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8f9fa;
        }

        .map-container {
            height: 350px;
            width: 100%;
            border-radius: 6px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
            border: 2px solid #dee2e6;
        }

        .delivery-vehicle {
            position: absolute;
            width: 32px;
            height: 32px;
            margin-left: -16px;
            margin-top: -16px;
            z-index: 1000;
            transition: transform 0.5s ease-in-out;
        }

        .map-legend {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px;
            font-size: 12px;
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .map-legend span {
            display: inline-block;
            margin-right: 15px;
            font-weight: 500;
        }

        .map-legend .pickup {
            color: #28a745;
        }

        .map-legend .dropoff {
            color: #dc3545;
        }

        .progress-info {
            background-color: rgba(0, 123, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            border-left: 4px solid #007bff;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-in-transit {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-delivered {
            background-color: #d4edda;
            color: #155724;
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 8px;
            z-index: 999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-panel button {
            margin: 2px;
            padding: 4px 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
    <div class="container">
        <a class="navbar-brand" href="/">Courier App</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <form method="post" action="/internal/logout" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-orange">Logout</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="full-height-container">
    <nav class="sidebar">
        <a href="/internal/orders">Orders</a>
        <a href="/internal/order/tracking">Tracking</a>
        <a href="/internal/billing" class="bg-secondary text-white">Billing</a>
        <div class="dropdown">
            <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="collapse"
               data-bs-target="#adminSubMenu" aria-expanded="false" aria-controls="adminSubMenu">
                Admin Module
            </a>
            <div class="collapse" id="adminSubMenu">
                <a href="/internal/admin/customers" class="ps-4">Customers</a>
                <a href="/internal/admin/users" class="ps-4">Users</a>
            </div>
        </div>
        <div class="dropdown">
            <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="collapse"
               data-bs-target="#settingsSubMenu" aria-expanded="false" aria-controls="settingsSubMenu">
                Setting
            </a>
        </div>
    </nav>

    <div class="main-content">
        <main class="scrollable-section">
            <div class="border rounded p-4 mb-4 bg-white shadow-sm">
                <h1 class="h4 mb-4 fw-semibold">Track Your Orders</h1>

                <form th:action="@{/internal/order/tracking}" method="get" class="mb-4">
                    <div class="row g-2">
                        <div class="col">
                            <input type="text" name="courierId" placeholder="Enter Courier ID"
                                   class="form-control" th:value="${searchQuery}"/>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-secondary btn-block">
                                Search
                            </button>
                        </div>
                        <div class="col-auto" th:if="${searchQuery != null && !searchQuery.isEmpty()}">
                            <a th:href="@{/internal/order/tracking}" class="btn btn-outline-secondary">
                                Clear
                            </a>
                        </div>
                    </div>
                </form>

                <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                    <span th:text="${errorMessage}">Error message</span>
                </div>
            </div>

            <div style="max-height: calc(100vh - 220px); overflow-y: auto;" class="pe-2">
                <div th:if="${orderFormData.isEmpty()}" class="border rounded p-4 mb-3 bg-white shadow-sm text-center">
                    <p class="mb-0">Order not found</p>
                </div>

                <div th:each="formData, formDataStat : ${orderFormData}" class="border rounded p-4 mb-3 bg-white shadow-sm">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5>Order #<span th:text="${formData.order.courierId}">N/A</span></h5>
                            <p class="text-muted small mb-0">
                                Placed on <span th:text="${formData.order.createdDate}">N/A</span>
                            </p>
                            <p class="text-muted small mb-0">
                                Delivery By <span th:text="${formData.dispatcher.firstName + ' ' + formData.dispatcher.lastName}">N/A</span>
                            </p>
                        </div>
                        <div>
                            <span class="status-badge status-in-transit">In Transit</span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="d-flex justify-content-between text-muted small mb-1">
                            <span>Order Placed</span>
                            <span>Shipped</span>
                            <span>Out for Delivery</span>
                            <span>Delivered</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-primary" role="progressbar" th:style="'width:' + ${formData.order.progressPercent} + '%'"></div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <details open>
                            <summary style="cursor:pointer; font-weight: 600;">View Live Tracking</summary>
                            <div class="mt-2 small text-dark">
                                <p><strong>Customer Email:</strong> <span th:text="${formData.order.customer.email}">N/A</span></p>
                                <p><strong>Customer Phone:</strong> <span th:text="${formData.order.customer.phoneNumber}">N/A</span></p>
                                <p><strong>Delivery Address:</strong> <span th:text="${formData.order.customer.address}">N/A</span></p>

                                <div class="progress-info">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span><strong>Delivery Progress:</strong> <span th:text="${formData.order.progressPercent}">0</span>% Complete</span>
                                        <span class="text-primary" th:id="'distance-' + ${formDataStat.index}">Calculating route...</span>
                                    </div>
                                </div>

                                <div class="map-container" th:id="'map-' + ${formDataStat.index}">
                                    <div class="delivery-vehicle" th:id="'vehicle-' + ${formDataStat.index}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                                            <rect width="32" height="32" rx="16" fill="#007bff" fill-opacity="0.1"/>
                                            <path d="M6 14L8 10H12H20L22 14V20H20C20 21.1 19.1 22 18 22C16.9 22 16 21.1 16 20H12C12 21.1 11.1 22 10 22C8.9 22 8 21.1 8 20H6V14Z" fill="#007bff"/>
                                            <circle cx="10" cy="20" r="1.5" fill="#ffffff"/>
                                            <circle cx="18" cy="20" r="1.5" fill="#ffffff"/>
                                            <rect x="9" y="12" width="10" height="2" fill="#ffffff" fill-opacity="0.8"/>
                                        </svg>
                                    </div>

                                    <div class="control-panel">
                                        <button type="button" class="btn btn-sm btn-outline-info" th:onclick="'updateVehicleLocation(' + ${formDataStat.index} + ')'">üîÑ Update Location</button>
                                        <button type="button" class="btn btn-sm btn-outline-success" th:onclick="'centerOnVehicle(' + ${formDataStat.index} + ')'">üìç Center on Vehicle</button>
                                    </div>

                                    <div class="map-legend">
                                        <span class="pickup"><strong>üü¢ Pick Up</strong>: Pickup Location</span>
                                        <span class="dropoff"><strong>üî¥ Drop Off</strong>: Delivery Address</span>
                                        <div style="margin-top: 5px;">
                                            <span style="color: #007bff;"><strong>üöó</strong>: Live Vehicle Position</span>
                                        </div>
                                    </div>
                                </div>

                                <div th:attr="data-pickup-lat=${formData.order.pickupLatitude ?: '40.7128'},
                                            data-pickup-lng=${formData.order.pickupLongitude ?: '-74.0060'},
                                            data-dropoff-lat=${formData.order.dropoffLatitude ?: '40.7589'},
                                            data-dropoff-lng=${formData.order.dropoffLongitude ?: '-73.9851'},
                                            data-current-lat=${formData?.vehicle?.currentLatitude ?: '0'},
                                            data-current-lng=${formData?.vehicle?.currentLongitude ?: '0'},
                                            data-progress=${formData.order.progressPercent ?: '75'}"
                                     th:id="'coords-' + ${formDataStat.index}"
                                     style="display:none;"></div>

                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script th:inline="javascript">
    const GOOGLE_MAPS_API_KEY = "SampleToBeReplace";
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const maps = [];
    const markers = [];
    const vehicleMarkers = [];
    const paths = [];
    const directionsServices = [];
    const directionsRenderers = [];
    let routePaths = [];

    function initMaps() {
        const orderItems = document.querySelectorAll('[id^="coords-"]');

        orderItems.forEach((item, index) => {
            const pickupLat = parseFloat(item.getAttribute('data-pickup-lat'));
            const pickupLng = parseFloat(item.getAttribute('data-pickup-lng'));
            const dropoffLat = parseFloat(item.getAttribute('data-dropoff-lat'));
            const dropoffLng = parseFloat(item.getAttribute('data-dropoff-lng'));
            const currentLat = parseFloat(item.getAttribute('data-current-lat'));
            const currentLng = parseFloat(item.getAttribute('data-current-lng'));
            const progress = parseFloat(item.getAttribute('data-progress')) / 100;

            const mapElement = document.getElementById(`map-${index}`);

            const centerLat = (pickupLat + dropoffLat) / 2;
            const centerLng = (pickupLng + dropoffLng) / 2;

            const map = new google.maps.Map(mapElement, {
                center: { lat: centerLat, lng: centerLng },
                zoom: 13,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                },
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            maps.push(map);

            // Create directions service and renderer
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#007bff',
                    strokeOpacity: 0.8,
                    strokeWeight: 4
                }
            });

            directionsServices.push(directionsService);
            directionsRenderers.push(directionsRenderer);
            directionsRenderer.setMap(map);

            // Custom markers for pickup and dropoff
            const pickupMarker = new google.maps.Marker({
                position: { lat: pickupLat, lng: pickupLng },
                map: map,
                title: 'Pickup Location',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#28a745',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    scale: 10
                },
                label: {
                    text: 'A',
                    color: 'white',
                    fontWeight: 'bold'
                }
            });

            const dropoffMarker = new google.maps.Marker({
                position: { lat: dropoffLat, lng: dropoffLng },
                map: map,
                title: 'Delivery Address',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#dc3545',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    scale: 10
                },
                label: {
                    text: 'B',
                    color: 'white',
                    fontWeight: 'bold'
                }
            });

            const vehicleMarker = new google.maps.Marker({
                position: { lat: currentLat, lng: currentLng },
                map: map,
                title: 'Delivery Vehicle - Live Location',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">

                <rect x="10" y="20" width="20" height="6" rx="1" ry="1" fill="#FF4500"/>

                <path d="M12 20 L12 16 A2 2 0 0 1 14 14 L20 14 A2 2 0 0 1 22 16 L22 20 Z" fill="#E03C00"/>

                <rect x="14" y="16" width="6" height="3" rx="0.5" ry="0.5" fill="#ADD8E6" opacity="0.7"/>

                <circle cx="14" cy="27" r="2.5" fill="#000000"/>
                <circle cx="26" cy="27" r="2.5" fill="#000000"/>
            </svg>
        `),
                    scaledSize: new google.maps.Size(80, 80),
                    anchor: new google.maps.Point(40, 40)
                },
                zIndex: 1000
            });

            markers.push([pickupMarker, dropoffMarker]);
            vehicleMarkers.push(vehicleMarker);

            const request = {
                origin: { lat: pickupLat, lng: pickupLng },
                destination: { lat: dropoffLat, lng: dropoffLng },
                travelMode: google.maps.TravelMode.DRIVING,
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);

                    const route = result.routes[0];
                    const leg = route.legs[0];
                    routePaths[index] = route.overview_path;

                    document.getElementById(`distance-${index}`).textContent =
                        `${leg.distance.text} ‚Ä¢ ${leg.duration.text}`;

                    positionVehicleOnRoute(index, currentLat, currentLng);
                }
            });

            // Fit bounds to show all markers including vehicle
            const bounds = new google.maps.LatLngBounds();
            bounds.extend({ lat: pickupLat, lng: pickupLng });
            bounds.extend({ lat: dropoffLat, lng: dropoffLng });
            bounds.extend({ lat: currentLat, lng: currentLng });
            map.fitBounds(bounds);

            map.addListener('click', (event) => {
                updateVehiclePosition(index, event.latLng.lat(), event.latLng.lng());
            });
        });

        startLocationTracking();
    }

    function positionVehicleOnRoute(index, lat, lng) {
        const vehicleMarker = vehicleMarkers[index];
        const newPosition = { lat: lat, lng: lng };

        vehicleMarker.setPosition(newPosition);

        if (routePaths[index]) {
            const progress = calculateProgressAlongRoute(index, lat, lng);
            updateProgressDisplay(index, progress);
        }
    }

    function calculateProgressAlongRoute(index, currentLat, currentLng) {
        const routePath = routePaths[index];
        if (!routePath || routePath.length === 0) return 0;

        let minDistance = Infinity;
        let closestIndex = 0;

        for (let i = 0; i < routePath.length; i++) {
            const distance = calculateDistance(
                currentLat, currentLng,
                routePath[i].lat(), routePath[i].lng()
            );
            if (distance < minDistance) {
                minDistance = distance;
                closestIndex = i;
            }
        }

        // Calculate progress as percentage along the route
        const progress = (closestIndex / (routePath.length - 1)) * 100;
        return Math.round(Math.max(0, Math.min(100, progress)));
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function updateProgressDisplay(index, progress) {
        const progressBar = document.querySelector(`[data-index="${index}"] .progress-bar`);
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }

        const progressText = document.querySelector(`[data-index="${index}"] .progress-info span`);
        if (progressText) {
            progressText.innerHTML = `<strong>Delivery Progress:</strong> ${progress}% Complete`;
        }
    }

    // Simulate real-time location updates (in real app, this would come from your backend)
    function startLocationTracking() {
        setInterval(() => {
            // In a real application, you would fetch current locations from your backend API
            // For demo purposes, we'll simulate small location changes
            vehicleMarkers.forEach((marker, index) => {
                if (Math.random() > 0.7) { // 30% chance of update each interval
                    simulateLocationUpdate(index);
                }
            });
        }, 5000); // Check for updates every 5 seconds
    }

    function simulateLocationUpdate(index) {
        const currentPos = vehicleMarkers[index].getPosition();
        if (currentPos && routePaths[index]) {
            // Simulate slight movement along the route
            const routePath = routePaths[index];
            const currentIndex = findClosestRouteIndex(index, currentPos.lat(), currentPos.lng());

            if (currentIndex < routePath.length - 1) {
                const nextPoint = routePath[Math.min(currentIndex + 1, routePath.length - 1)];
                const newLat = currentPos.lat() + (nextPoint.lat() - currentPos.lat()) * 0.1;
                const newLng = currentPos.lng() + (nextPoint.lng() - currentPos.lng()) * 0.1;

                updateVehiclePosition(index, newLat, newLng);
            }
        }
    }

    function findClosestRouteIndex(index, lat, lng) {
        const routePath = routePaths[index];
        let minDistance = Infinity;
        let closestIndex = 0;

        for (let i = 0; i < routePath.length; i++) {
            const distance = calculateDistance(lat, lng, routePath[i].lat(), routePath[i].lng());
            if (distance < minDistance) {
                minDistance = distance;
                closestIndex = i;
            }
        }
        return closestIndex;
    }

    // Control functions
    function updateVehicleLocation(index) {
        // In a real app, this would fetch the latest location from your API
        // For demo, we'll simulate a location update
        const currentPos = vehicleMarkers[index].getPosition();
        if (currentPos && routePaths[index]) {
            simulateLocationUpdate(index);

            // Show notification
            showNotification(`Vehicle location updated for Order #${index + 1}`);
        }
    }

    function centerOnVehicle(index) {
        const vehicleMarker = vehicleMarkers[index];
        const map = maps[index];
        const position = vehicleMarker.getPosition();

        if (position) {
            map.setCenter(position);
            map.setZoom(15);

            // Add a subtle bounce animation to the vehicle marker
            vehicleMarker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(() => {
                vehicleMarker.setAnimation(null);
            }, 2000);
        }
    }

    function updateVehiclePosition(index, lat, lng) {
        positionVehicleOnRoute(index, lat, lng);

        // In a real application, you would also send this update to your backend
        console.log(`Vehicle ${index} position updated:`, { lat, lng });
    }

    function showNotification(message) {
        // Simple notification (you can replace with a proper notification system)
        const notification = document.createElement('div');
        notification.className = 'alert alert-info position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <span class="me-2">üìç</span>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.body.appendChild(notification);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 3000);
    }
</script>
<script th:inline="javascript">
    function loadGoogleMapsApi() {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMaps&libraries=geometry`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Error loading Google Maps API. Please check your API key.');
        };
        document.head.appendChild(script);
    }

    window.addEventListener('load', loadGoogleMapsApi);
</script>
</body>
</html>