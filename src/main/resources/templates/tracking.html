<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Order Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        .full-height-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #ff3030;
            color: white;
            padding-top: 1rem;
            overflow-y: auto;
        }

        .sidebar a {
            color: #fff;
            padding: 15px;
            display: block;
            text-decoration: none;
        }

        .sidebar a:hover {
            background-color: #495057;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .navbar-sticky {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .scrollable-section {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f8f9fa;
        }

        .map-container {
            height: 250px;
            width: 100%;
            border-radius: 6px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        .delivery-vehicle {
            position: absolute;
            width: 24px;
            height: 24px;
            margin-left: -12px;
            margin-top: -12px;
            z-index: 10;
        }

        .map-legend {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            padding: 5px 10px;
            margin: 5px;
            font-size: 12px;
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 5;
        }

        .map-legend span {
            display: inline-block;
            margin-right: 10px;
        }

        .map-legend .pickup {
            color: green;
        }

        .map-legend .dropoff {
            color: red;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
    <div class="container">
        <a class="navbar-brand" href="/">Courier App</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="btn btn-outline" href="/internal/logout">Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="full-height-container">
    <nav class="sidebar">
        <a href="/internal/orders">Orders</a>
        <a href="/internal/order/tracking">Tracking</a>
        <a href="/internal/billing" class="bg-secondary text-white">Billing</a>
        <div class="dropdown">
            <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="collapse"
               data-bs-target="#adminSubMenu" aria-expanded="false" aria-controls="adminSubMenu">
                Admin Module
            </a>
            <div class="collapse" id="adminSubMenu">
                <a href="/internal/admin/customers" class="ps-4">Customers</a>
                <a href="/internal/admin/users" class="ps-4">Users</a>
            </div>
        </div>
        <div class="dropdown">
            <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="collapse"
               data-bs-target="#settingsSubMenu" aria-expanded="false" aria-controls="settingsSubMenu">
                Setting
            </a>
        </div>
    </nav>

    <div class="main-content">
        <main class="scrollable-section">
            <div class="border rounded p-4 mb-4 bg-white shadow-sm">
                <h1 class="h4 mb-4 fw-semibold">Track Your Orders</h1>

                <form th:action="@{/internal/order/tracking}" method="get" class="mb-4">
                    <div class="row g-2">
                        <div class="col">
                            <input type="text" name="courierId" placeholder="Enter Courier ID"
                                   class="form-control" th:value="${searchQuery}"/>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-secondary btn-block">
                                Search
                            </button>
                        </div>
                        <div class="col-auto" th:if="${searchQuery != null && !searchQuery.isEmpty()}">
                            <a th:href="@{/internal/order/tracking}" class="btn btn-outline-secondary">
                                Clear
                            </a>
                        </div>
                    </div>
                </form>

                <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                    <span th:text="${errorMessage}">Error message</span>
                </div>
            </div>

            <div style="max-height: calc(100vh - 220px); overflow-y: auto;" class="pe-2">
                <div th:if="${orderFormData.isEmpty()}" class="border rounded p-4 mb-3 bg-white shadow-sm text-center">
                    <p class="mb-0">Order not found</p>
                </div>

                <div th:each="formData, formDataStat : ${orderFormData}" class="border rounded p-4 mb-3 bg-white shadow-sm">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>Order #<span th:text="${formData.order.courierId}">N/A</span></h5>
                            <p class="text-muted small mb-0">
                                Placed on <span th:text="${formData.order.createdDate}">N/A</span>
                            </p>
                            <p class="text-muted small mb-0">
                                Delivery By <span th:text="${formData.dispatcher.firstName + ' ' + formData.dispatcher.lastName}">N/A</span>
                            </p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="d-flex justify-content-between text-muted small mb-1">
                            <span>Order Placed</span>
                            <span>Shipped</span>
                            <span>Out for Delivery</span>
                            <span>Delivered</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-secondary" role="progressbar" th:style="'width:' + ${formData.order.progressPercent} + '%'"></div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <details>
                            <summary style="cursor:pointer;">View Details</summary>
                            <div class="mt-2 small text-dark">
                                <p><strong>Customer Email:</strong> <span th:text="${formData.order.customer.email}">N/A</span></p>
                                <p><strong>Customer Phone:</strong> <span th:text="${formData.order.customer.phoneNumber}">N/A</span></p>
                                <p><strong>Delivery Address:</strong> <span th:text="${formData.order.customer.address}">N/A</span></p>
                                <div class="map-container" th:id="'map-' + ${formDataStat.index}">
                                    <div class="delivery-vehicle" th:id="'vehicle-' + ${formDataStat.index}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#2563eb" stroke="#ffffff" stroke-width="2">
                                            <path d="M1 3.5H17M17 3.5V12M17 3.5H18.5L22.5 8.5V12M17 12V18.5C17 19.0523 16.5523 19.5 16 19.5H14.75M17 12H22.5M22.5 12V18.5C22.5 19.0523 22.0523 19.5 21.5 19.5H20.25M14.75 19.5C14.75 20.7426 13.7426 21.75 12.5 21.75C11.2574 21.75 10.25 20.7426 10.25 19.5M14.75 19.5C14.75 18.2574 13.7426 17.25 12.5 17.25C11.2574 17.25 10.25 18.2574 10.25 19.5M20.25 19.5C20.25 20.7426 19.2426 21.75 18 21.75C16.7574 21.75 15.75 20.7426 15.75 19.5M20.25 19.5C20.25 18.2574 19.2426 17.25 18 17.25C16.7574 17.25 15.75 18.2574 15.75 19.5M15.75 19.5H14.75M10.25 19.5H5C3.89543 19.5 3 18.6046 3 17.5V13.5M3 13.5V6.5C3 4.84315 4.34315 3.5 6 3.5H9M3 13.5H9M9 13.5V9.5M9 13.5H12V9.5M9 9.5V3.5M9 9.5H12M9 3.5H12V9.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="map-legend">
                                        <span class="pickup"><strong>A</strong>: Pickup</span>
                                        <span class="dropoff"><strong>B</strong>: Dropoff</span>
                                    </div>
                                </div>
                                <div th:attr="data-pickup-lat=${formData.order.pickupLatitude ?: '0'},
                                            data-pickup-lng=${formData.order.pickupLongitude ?: '0'},
                                            data-dropoff-lat=${formData.order.dropoffLatitude ?: '0'},
                                            data-dropoff-lng=${formData.order.dropoffLongitude ?: '0'}"
                                     th:id="'coords-' + ${formDataStat.index}"
                                     style="display:none;"></div>

                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script th:inline="javascript">
    const GOOGLE_MAPS_API_KEY = "AIzaSyADwHrsnRYiB37pHoP5vm0GBfPSIMeaqpk";
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const maps = [];
    const markers = [];
    const vehicles = [];
    const paths = [];

    function initMaps() {
        const orderItems = document.querySelectorAll('[id^="coords-"]');

        orderItems.forEach((item, index) => {
            const pickupLat = parseFloat(item.getAttribute('data-pickup-lat'));
            const pickupLng = parseFloat(item.getAttribute('data-pickup-lng'));
            const dropoffLat = parseFloat(item.getAttribute('data-dropoff-lat'));
            const dropoffLng = parseFloat(item.getAttribute('data-dropoff-lng'));

            const mapElement = document.getElementById(`map-${index}`);

            const centerLat = (pickupLat + dropoffLat) / 2;
            const centerLng = (pickupLng + dropoffLng) / 2;

            const map = new google.maps.Map(mapElement, {
                center: { lat: centerLat, lng: centerLng },
                zoom: 12,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                }
            });

            maps.push(map);

            const pickupMarker = new google.maps.Marker({
                position: { lat: pickupLat, lng: pickupLng },
                map: map,
                title: 'Pickup Location',
                label: 'PL',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: 'green',
                    fillOpacity: 1,
                    strokeWeight: 0,
                    scale: 8
                }
            });

            const dropoffMarker = new google.maps.Marker({
                position: { lat: dropoffLat, lng: dropoffLng },
                map: map,
                title: 'Dropoff Location',
                label: 'DL',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: 'red',
                    fillOpacity: 1,
                    strokeWeight: 0,
                    scale: 8
                }
            });

            markers.push([pickupMarker, dropoffMarker]);

            const path = new google.maps.Polyline({
                path: [
                    { lat: pickupLat, lng: pickupLng },
                    { lat: dropoffLat, lng: dropoffLng }
                ],
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 3
            });

            path.setMap(map);
            paths.push(path);

            const bounds = new google.maps.LatLngBounds();
            bounds.extend({ lat: pickupLat, lng: pickupLng });
            bounds.extend({ lat: dropoffLat, lng: dropoffLng });
            map.fitBounds(bounds);

            const vehicleElement = document.getElementById(`vehicle-${index}`);
            vehicles.push({
                element: vehicleElement,
                position: 0,
                pickupLat: pickupLat,
                pickupLng: pickupLng,
                dropoffLat: dropoffLat,
                dropoffLng: dropoffLng
            });

            animateVehicle(index);
        });
    }

    function animateVehicle(index) {
        const vehicle = vehicles[index];
        const map = maps[index];

        function animate() {
            vehicle.position += 0.005;
            if (vehicle.position > 1) {
                vehicle.position = 0;
            }

            const lat = vehicle.pickupLat + (vehicle.dropoffLat - vehicle.pickupLat) * vehicle.position;
            const lng = vehicle.pickupLng + (vehicle.dropoffLng - vehicle.pickupLng) * vehicle.position;

            const projection = map.getProjection();
            if (projection) {
                const latLng = new google.maps.LatLng(lat, lng);
                const point = projection.fromLatLngToPoint(latLng);
                const mapDiv = map.getDiv();
                const topRight = projection.fromLatLngToPoint(map.getBounds().getNorthEast());
                const bottomLeft = projection.fromLatLngToPoint(map.getBounds().getSouthWest());
                const scale = Math.pow(2, map.getZoom());

                const x = (point.x - bottomLeft.x) * scale;
                const y = (point.y - topRight.y) * scale;

                vehicle.element.style.left = x + 'px';
                vehicle.element.style.top = y + 'px';
            }

            requestAnimationFrame(animate);
        }

        google.maps.event.addListenerOnce(map, 'idle', function() {
            animate();
        });
    }
</script>
<script th:inline="javascript">
    function loadGoogleMapsApi() {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMaps`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }

    window.addEventListener('load', loadGoogleMapsApi);
</script>
</body>
</html>